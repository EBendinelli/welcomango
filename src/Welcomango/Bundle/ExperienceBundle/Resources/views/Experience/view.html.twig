{% extends "::front.html.twig" %}

{% trans_default_domain "interface" %}

{#{% form_theme form with ["::frontTheme.html.twig"] %}#}

{% block page_content %}
    <!-- START CONTENT SECTION -->
    {% if experience.getMedias.first %}

    {% else %}
        {% set imageBanner = asset("img/front/places-" ~ random(18) ~ ".jpg") %}
    {% endif %}
    <!-- START BANNER SECTION -->
    <section class="p-b-70 bg-master-darkest sm-no-margin" data-pages-bg-image="{{ asset(imageBanner) }}" data-bg-overlay="black" data-overlay-opacity="0.3" data-pages="parallax">
        <div class="container p-t-50">
            <div class="row">
                <div class="col-lg-1 col-min">
                    <div class="text-center">
                        <h1 class="text-white col-sm-12 ">{{ experience.title }}</h1>
                        <div class="m-b-10">
                            {{ include("WelcomangoCoreBundle:Core:note.html.twig", { 'note': experience.getAverageNote, 'size': 'medium'}) }}
                        </div>
                        <p class="fs-12 font-arial text-white ">{{ 'experience.experienceShortText'|trans({'%experienceDuration%': experience.estimatedDuration, '%experienceCreator%': experience.getCreator.firstname}) }}</p>
                        <div class="text-center text-white">{{ display_tag(experience.getTags) }}</div>
                        {% if app.user == experience.getCreator %}
                            <a href="{{ path('front_experience_edit', {'experience_id': experience.id}) }}" class="btn btn-lg btn-complete btn-cons btn-rounded m-t-20"><i class="fa fa-pencil"></i> {{ 'profile.editExperience'|trans }}</a>
                        {% else %}
                            <button id="experience-booking-btn" type="button" class="btn btn-lg btn-primary btn-cons btn-rounded m-t-20" onclick="toggleBooking()">
                                {{ 'experience.sendRequest'|trans }}
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div id="experience-booking" {% if formSubmitted == true %}style="height:500px"{% endif %} >
                {{ include("WelcomangoExperienceBundle:Experience:_experienceBooking.html.twig") }}
            </div>
        </div>
    </section>
    <!-- END BANNER SECTION -->

    <!-- START EXPERIENCE SECTION -->
    <section class="container-fluid p-b-50  bg-white">
        <div class="container">
            <div class="panel col-md-8 p-t-40">
                <ul class="nav nav-tabs nav-tabs-left nav-tabs-simple" id="experience-side-menu">
                    <li class="active">
                        <a data-toggle="tab" data-href="#experience-city" class="experience-side-menu-item">City</a>
                    </li>
                    <li>
                        <a data-toggle="tab" data-href="#experience-details" class="experience-side-menu-item">Details</a>
                    </li>
                    <li>
                        <a data-toggle="tab" data-href="#experience-description" class="experience-side-menu-item">Description</a>
                    </li>
                    <li>
                        <a data-toggle="tab" data-href="#experience-pictures" class="experience-side-menu-item">Pictures</a>
                    </li>
                </ul>
                <div class="experience-content">
                    <div id="experience-city">
                        <div class="experience-city">
                            <div class="m-l-20 p-b-20">
                                <div class="experience-city-picto" style="background-image:url({{ asset('img/welcomango-picto.png') }}">
                                    {# TODO see if we add the note in this mango. If so, add white BG to the picture #}
                                    {#<div class="experience-picto-note">
                                        <h4 class="text-primary bold">{{ experience.getAverageNote }}<i class="fa fa-star fa-sm"></i></h4>
                                    </div>#}
                                </div>
                                <h1 class="experience-city-title">{{ experience.getCity.name }}</h1>
                                <h4>{{ experience.getCity.getCountry.name }}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane" id="experience-details">
                        <div class="row">
                            <div class="col-md-12 m-t-20">
                                <h3>{{  'experience.details'|trans }}</h3>
                                <div class="col-md-6">
                                    <div >
                                        {{  'experience.estimatedDuration'|trans }}: <span class="text-black semi-bold">{{ experience.getEstimatedDuration}}h</span>
                                    </div>
                                    <div >
                                        {{  'experience.maximumParticipants'|trans }}: <span class="text-black semi-bold">{{ experience.maximumParticipants}}</span>
                                    </div>
                                    <div >
                                        {% set experienceHappened = 0 %}
                                        {% for booking in experience.bookings %}
                                            {% if booking.status == "Happened" %}
                                                {% set experienceHappened = experienceHappened + 1  %}
                                            {% endif %}
                                        {% endfor %}
                                        {{  'experience.happenedTimes'|trans }}: <span class="text-black semi-bold">{{ experienceHappened}}</span>
                                    </div>
                                </div>
                                <div class="col-md-6">

                                    <div >
                                        {{  'experience.minimunDuration'|trans }}: <span class="text-black semi-bold">{{ experience.getMinimumDuration}}h</span>
                                    </div>
                                    <div >
                                        {{  'experience.maximumDuration'|trans }}: <span class="text-black semi-bold">{{ experience.getMaximumDuration}}h</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane" id="experience-description">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="experience-description m-t-20">
                                    <h3>{{  'experience.description'|trans }}</h3>
                                    <p>{{ experience.description|nl2br|raw }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane" id="experience-pictures">
                        <div class="row">
                            <div class="col-md-12">
                                <h3>{{  'experience.pictures'|trans }}</h3>
                                <p>
                                    {% if experience.getMedias.first %}
                                        <div class="experience_container_pictures">
                                            <div class="col-md-12 ">
                                                <div class="experience_featured_picture_dark">
                                                    <div class="experience_featured_pictures experience_featured_picture_large m-b-20" style="background-image:url({{ asset(experience.getMedias.first.getWebPath) }})">                                            </div>
                                                </div>
                                            </div>
                                            {% for media in experience.getMedias.getValues|slice(1,2) %}
                                                <div class="col-md-6">
                                                    <div class="experience_featured_picture_dark">
                                                        <div class="experience_featured_pictures experience_featured_picture_small m-b-20" style="background-image:url({{ asset(media.getWebPath) }})"></div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                            {% for media in experience.getMedias.getValues|slice(3,10) %}
                                                <div id="experience-hidden-pictures">
                                                    <div class="col-md-6">
                                                        <div class="experience_featured_picture_dark">
                                                            <div class="experience_featured_pictures experience_featured_picture_small m-b-20" style="background-image:url({{ asset(media.getWebPath) }})"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                            {% if experience.getMedias.getValues[3] is defined %}
                                                <div class="col-md-12 text-right">
                                                    <button id="experience-pictures-btn" class="text-center btn btn-sm" onclick="togglePictures();">More</button>
                                                </div>
                                            {% endif %}

                                        </div>
                                    {% else %}
                                        <div>
                                            {{ 'experience.sorryNoPictures'|trans }}
                                            <i class="fa fa-meh-o"></i>
                                        </div>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4" id="experience-user-container" >
                <div class="bg-master-lighter row" id="experience-user">
                    <!-- MAIN USER DISPLAY -->
                    <div id="user-main">
                        <div class="user" onclick="location.href='{{ path('front_user_view', {'user_id' : experience.getCreator.id }) }}'">
                            <div class="user-item user-img-1">
                                <div class="user-info-wrap">
                                    <div class="user-info">
                                        {{ display_avatar(experience.getCreator, false, true, 'user-info-front') }}
                                        <div class="user-info-back bg-master-dark">
                                            <div class="m-t-60 text-center">
                                                <span>View Profile</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <a href="{{ path('front_user_view', {'user_id' : experience.getCreator.id }) }}">
                            <h2 class="text-center">{{ experience.getCreator.firstname }}, {{ experience.getCreator.getAge }}</h2>
                        </a>
                    </div>
                    <!-- MINI USER DISPLAY -->
                    <div id="user-mini" class="row p-b-5 p-t-5 " style="display:none">
                        <div class="col-md-12">
                            <div class="col-md-1"></div>
                            <div class="col-md-3">
                                <a href="{{ path('front_experience_list') }}">
                                    {{ display_avatar(experience.getCreator, false, true, 'user-info-front-small') }}
                                </a>
                            </div>
                            <div class="col-md-7 text-left">
                                <a href="{{ path('front_experience_list') }}">
                                    <h4>{{ experience.getCreator.firstname }}, {{ experience.getCreator.getAge }}</h4>
                                </a>
                            </div>
                        </div>
                    </div>
                    <!-- USER INFO CONTENT-->
                    <div class="experience-user-info">
                        <div class="dotted-line"><span></span></div>
                        <div class="text-center m-b-15 ">
                            {% for language in experience.getCreator.getSpokenLanguages.getValues %}
                                <div class="flag flag-xs" role="image"  style="background: url({{ asset('img/countries/'~ language.language.flagLabel|lower ~'.svg') }});"></div>
                            {% endfor %}

                        </div>
                        <p>{{ experience.getCreator.getDescription|truncate(200) }}</p>
                    </div>
                    <!-- BOOKING  AND PRICE PART -->
                    <div class="bg-master-lighter experience-bottom-user">
                        <div class="row experience-bottom-container">
                            <div class="experience-bottom-contact col-md-5">
                                <i class="fa fa-comments-o fa-5x text-primary m-l-40 m-t-30"></i>
                            </div>
                            <div class="col-md-7 experience-bottom-right">
                                <div class="experience-image-separation">
                                    <div class="experience-image-triangle"></div>
                                </div>
                                <div class="experience-bottom-price bg-master-light" {% if app.user != experience.getCreator %}onclick="userToggleBooking(){% endif %}">
                                    <div class=" experience-price">
                                        {{ experience.pricePerHour }}€/h
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="experience-force-size p-b-10"></div>
        </div>
    </section>
    <!-- END EXPERIENCE SECTION -->

    <!-- START COMMENT SECTION -->
    <section class="container-fluid bg-master-lighter container-fixed-lg p-b-50">
        <div class="row">
            <div class="container">
                <div class="m-b-40 m-t-40">
                    <h2 class="text-center m-b-40">Comments</h2>
                    <div id="experience-comments">
                        {% include("WelcomangoExperienceBundle:Comment:list.html.twig") with { 'comments': comments } %}
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- END COMMENT SECTION -->

    <!-- START RELATED SECTION -->
    <section class="container-fluid bg-white container-fixed-lg p-b-50">
        <div class="row">
            <div class="container">
                <div class="text-center m-b-40 m-t-40">
                    <h2>Related experiences</h2>
                </div>
                {% for experience in relatedExperiences  %}
                    {{ include("WelcomangoExperienceBundle:Experience:_experienceTile.html.twig", { 'experiences': relatedExperiences, 'column': 3, 'darkBg': true }) }}
                {% endfor %}
            </div>
        </div>
    </section>
    <!-- END RELATED SECTION -->

    <!-- END CONTENT SECTION -->
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript">

        //Smooth scroll + update active menu item
        $('.experience-side-menu-item').click(function(){
            var anchor = $(this).attr('data-href');
            var offset = $(anchor).offset().top;
            $('html, body').animate( { scrollTop: offset - 50 }, 750 );

            $('.experience-side-menu-item').parent().removeClass('active');
            $(this).parent().toggleClass('active');
        });

        //Make the menu and user card sticky to top
        $("#experience-user-container").stick_in_parent({offset_top: 80});
        $("#experience-side-menu").stick_in_parent({offset_top: 80});

        /* //Update active menu on scroll
        $(window).on("scroll", function() {
            var scrollPosition = scrollY || pageYOffset;

            if (scrollPosition > $("#experience-city").position().top - $(window).height()) {
                $("#experience-city").parent().toggleClass('active');
            }else if (scrollPosition > $("#experience-description").position().top - $(window).height()) {
                $("#experience-description").parent().toggleClass('active');
            }else if (scrollPosition > $("#experience-pictures").position().top - $(window).height()) {

                $("#experience-pictures").parent().toggleClass('active');
            }
        }); */

        //make the user card sticky
        $(function(){
            var stickyUserTop = $('#experience-user').offset().top-80;

            $(window).scroll(function(){
                if( $(window).scrollTop() > stickyUserTop ) {
                    //$('#user-main').animate({marginTop: '-200px'});
                    $('#user-main').hide();
                    $('#user-mini').show();
                } else {
                    //$('#user-main').animate({marginTop: '0px'});
                    $('#user-main').show();
                    $('#user-mini').hide();
                }
            });
        });

        function userToggleBooking(){
            if($('#experience-booking').height() == 0){
                $("html, body").animate({ scrollTop: $('.page-wrappers').offset().top }, 500);
                toggleBooking();
            }else{
                toggleBooking();
            }
        }

        function toggleBooking(){
            if($('#experience-booking').height() == 0){
                $('#experience-booking').animate({height: '500px', overflow: 'auto'});
                $('#experience-booking-btn').html('{{ 'experience.closeRequest'|trans }}')
            }else{
                $('#experience-booking').animate({height: '0px', overflow: 'hidden'});
                $('#experience-booking-btn').html('{{ 'experience.sendRequest'|trans }}')
            }
        }

        function togglePictures1(){
            $('#experience-hidden-pictures').toggleClass('experience-pictures-visible');
            $('#experience-pictures-btn').html('Less');
        }

        function togglePictures(){
            if($('#experience-hidden-pictures:visible').length == 0){
                $('#experience-hidden-pictures').show(400);
                $('#experience-pictures-btn').html('Less')
            }else{
                $('#experience-hidden-pictures').hide(400);
                $('#experience-pictures-btn').html('More')
            }
        }

        //Display only certain dates in the datepicker
        var startDate = new Date();
        var endDate = new Date();
        startDate.setDate(startDate.getDate());
        // This set the maximum date to one year from now
        endDate.setDate(endDate.getDate()+365);

        //forbiddenDates calculated earlier
        var forbidden = {{ forbiddenDates|json_encode|raw }};

        $('#front_booking_desired_date').datepicker({
            startDate: startDate,
            endDate: endDate,
            weekStart: 1,
            beforeShowDay:function(date){
                var curr_date = ("0" + date.getDate()).slice(-2);
                var curr_month = ("0" + (date.getMonth() + 1)).slice(-2);
                var curr_year = date.getFullYear();
                var curr_date = curr_year + "-" + curr_month + "-" + curr_date ;

                if (forbidden.indexOf(curr_date)>-1) return false;
            }
        });

    </script>

{% endblock %}
