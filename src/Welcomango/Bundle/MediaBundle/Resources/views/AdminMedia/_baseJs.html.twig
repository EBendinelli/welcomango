{% trans_default_domain 'interface' %}

<div id="preview-template">
    <div class="dz-preview dz-file-preview">
        <div class="dz-details">
            <div class="dz-filename"><span data-dz-name></span></div>
            <div class="dz-size" data-dz-size></div>
            <div class="dz-id" data-dz-id></div>
            <img data-dz-thumbnail/>
        </div>
        <div class="dz-progress"><span class="dz-upload" data-dz-uploadprogress></span></div>
        <div class="dz-error-message"><span data-dz-errormessage></span></div>
        <i class="fa fa-trash delete-icon" data-dz-remove></i>
    </div>
</div>

<script src="{{ asset('js/dropzone.js') }}"></script>
<script type="text/javascript">
    Dropzone.autoDiscover = false;
    var medias = [];
    $(function () {
        var dropzone = new Dropzone("div#medias", {
            url: "{{ oneup_uploader_endpoint('gallery') }}",
            uploadMultiple: true,
            acceptedFiles: 'image/*',
            maxFilesize: 5,
            maxThumbnailFilesize: 5,
            dictRemoveFile: "{{ 'interface.remove'|trans }}",
            dictDefaultMessage: "{{ 'medias.drop_files_here'|trans }}",
            addRemoveLinks: true,
            init: function () {
                {% if form.vars.data.id and experience is defined %}
                    {% for media in experience.medias %}
                    var mockFile = {name: "{{ media.originalFilename }}", size: 99999};
                    this.options.addedfile.call(this, mockFile);
                    this.options.thumbnail.call(this, mockFile, "{{ asset(media.getPath() | imagine_filter('thumb120')) ~ media.originalFilename }}");
                    mockFile.previewElement.classList.add('dz-success');
                    mockFile.previewElement.classList.add('dz-complete');
                    {% endfor %}
                {% endif %}
            }
        });

        var $container = $('div#front_experience_medias');
        $container.data('index', $container.find(':input').length);

        dropzone.on('successmultiple', function (file) {
            file.forEach(function (fileName) {
                addPicture(fileName, $container);
            });
        });

        dropzone.on('removedfile', function (file) {
            if ($('input:hidden[value="' + file.name + '"]').parent().parent().hasClass('tmp-file')) {
                deleteTmpMedia(file.name);
            }
            $('input:hidden[value="' + file.name + '"]').parent().parent().remove();
        });

        function addPicture(file, $container) {
            var index = $container.data('index');
            console.log(index);
            $container.append('<div class="tmp-file" ><div id="front_experience_medias_' + index + '"><input type="hidden" id="front_experience_medias_' + index + '_originalFilename" name="front_experience[medias][' + index + '][originalFilename]" value="' + file.name + '" /></div></div>');
            $container.data('index', index + 1);
        }

        function deleteTmpMedia(filename) {
            var formData = new FormData();
            formData.append("tempName", filename);

            $.ajax({
                url: '{{ path('media_delete') }}',
                type: 'POST',
                data: formData,
                cache: false,
                contentType: false,
                processData: false
            });
        }

    });
</script>
