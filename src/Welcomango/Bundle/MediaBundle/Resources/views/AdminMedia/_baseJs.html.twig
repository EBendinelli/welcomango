{% trans_default_domain 'interface' %}

<script src="{{ asset('js/dropzone.js') }}"></script>
<script type="text/javascript">
    var defaultMediaTemplate = '<div>DEFAULT</div>';
    Dropzone.autoDiscover = false;
    var medias = [];
    $(function () {
        var dropzone = new Dropzone("div#medias", {
            url: "{{ oneup_uploader_endpoint('gallery') }}",
            uploadMultiple: true,
            acceptedFiles: 'image/*',
            maxFilesize: 5,
            maxThumbnailFilesize: 5,
            dictRemoveFile: "{{ 'interface.remove'|trans }}",
            dictDefaultMessage: "{{ 'medias.drop_files_here'|trans }}",
            addRemoveLinks: true,
            init: function () {
                {% if form.vars.data.id and experience is defined %}
                {% for media in experience.medias %}
                var mockFile = {name: "{{ media.originalFilename }}", size: 99999};
                this.options.addedfile.call(this, mockFile);
                this.options.thumbnail.call(this, mockFile, "{{ asset(media.getPath() | imagine_filter('thumb120')) ~ media.originalFilename }}");
                mockFile.previewElement.classList.add('dz-success');
                mockFile.previewElement.classList.add('dz-complete');
                {% endfor %}
                {% endif %}
            }
        });

        var $container = $('div#front_experience_medias');
        $container.data('index', $container.find(':input').length);

        dropzone.on('successmultiple', function (file) {
            toggleDefaultMessage();
            file.forEach(function (fileName) {
                addPicture(fileName, $container);
            });
        });

        dropzone.on('removedfile', function (file) {
            if ($('input:hidden[value="' + file.name + '"]').parent().parent().hasClass('tmp-file')) {
                deleteTmpMedia(file.name);
            }
            toggleDefaultMessage();
            $('input:hidden[value="' + file.name + '"]').parent().parent().remove();
        });

        function addPicture(file, $container) {
            var index = $container.data('index');
            $container.append('' +
            '<div class="tmp-file" ><div id="front_experience_medias_' + index + '"><input type="hidden" class="defaultImageInput" id="front_experience_medias_' + index + '_default" name="front_experience[medias][' + index + '][default]" value="0" /><input type="hidden" id="front_experience_medias_' + index + '_originalFilename" name="front_experience[medias][' + index + '][originalFilename]" value="' + file.name + '" /></div>');
            $container.data('index', index + 1);
            $('.dz-preview').on('click', function () {
                $.each($('.dz-preview'), function(){
                    this.style.backgroundColor = "white";
                });
                this.style.backgroundColor = "black";
                this.value = defaultMediaTemplate;
                var filename = this.childNodes[3].childNodes[3].childNodes[0].innerHTML;
                var fileNameForm = document.querySelectorAll("input[value='"+filename+"']");
                fileNameForm[0].parentNode.childNodes[0].value = 1;
            });
        }

        function deleteTmpMedia(filename) {
            var formData = new FormData();
            formData.append("tempName", filename);

            $.ajax({
                url: '{{ path('media_delete') }}',
                type: 'POST',
                data: formData,
                cache: false,
                contentType: false,
                processData: false
            });
        }

        function toggleDefaultMessage() {
            if ($("#medias > div.dz-preview").length > 0) {
                $('.dz-default').hide();
            } else {
                $('.dz-default').show();
            }
        }

    });
</script>
